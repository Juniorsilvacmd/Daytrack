version: "3.7"

services:
  daytrack-frontend:
    image: nginx:alpine
    networks:
      - nioNet
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
      labels:
        - traefik.enable=true
        - traefik.http.routers.daytrack-frontend.rule=Host(`daytrack.niochat.com.br`)
        - traefik.http.routers.daytrack-frontend.entrypoints=websecure
        - traefik.http.routers.daytrack-frontend.tls.certresolver=letsencryptresolver
        - traefik.http.routers.daytrack-frontend.service=daytrack-frontend
        - traefik.http.services.daytrack-frontend.loadbalancer.server.port=80
        - traefik.http.services.daytrack-frontend.loadbalancer.passHostHeader=true
        - traefik.http.services.daytrack-frontend.loadbalancer.healthcheck.path=/
        - traefik.http.services.daytrack-frontend.loadbalancer.healthcheck.interval=10s
        - traefik.http.services.daytrack-frontend.loadbalancer.healthcheck.timeout=5s
    command: >
      sh -c "
      echo '<!DOCTYPE html>
      <html>
      <head>
        <title>DayTrack</title>
        <meta charset=\"utf-8\">
        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">
        <style>
          body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #1a1a1a; color: white; }
          .container { max-width: 800px; margin: 0 auto; text-align: center; }
          h1 { color: #3b82f6; margin-bottom: 20px; }
          .status { background: #22c55e; padding: 10px; border-radius: 5px; margin: 20px 0; }
          .info { background: #374151; padding: 15px; border-radius: 5px; margin: 20px 0; }
        </style>
      </head>
      <body>
        <div class=\"container\">
          <h1>ðŸš€ DayTrack</h1>
          <div class=\"status\">âœ… Frontend funcionando!</div>
          <div class=\"info\">
            <p><strong>Status:</strong> Sistema em desenvolvimento</p>
            <p><strong>DomÃ­nio:</strong> daytrack.niochat.com.br</p>
            <p><strong>VersÃ£o:</strong> Docker + Traefik</p>
          </div>
        </div>
      </body>
      </html>' > /usr/share/nginx/html/index.html &&
      nginx -g 'daemon off;'
      "

  daytrack-backend:
    image: python:3.11-slim
    networks:
      - nioNet
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1"
          memory: 1024M
        reservations:
          cpus: "0.5"
          memory: 512M
      labels:
        - traefik.enable=true
        - traefik.http.routers.daytrack-backend.rule=Host(`django.niochat.com.br`)
        - traefik.http.routers.daytrack-backend.entrypoints=websecure
        - traefik.http.routers.daytrack-backend.tls.certresolver=letsencryptresolver
        - traefik.http.routers.daytrack-backend.service=daytrack-backend
        - traefik.http.services.daytrack-backend.loadbalancer.server.port=8000
        - traefik.http.services.daytrack-backend.loadbalancer.passHostHeader=true
        - traefik.http.services.daytrack-backend.loadbalancer.healthcheck.path=/api/v1/
        - traefik.http.services.daytrack-backend.loadbalancer.healthcheck.interval=10s
        - traefik.http.services.daytrack-backend.loadbalancer.healthcheck.timeout=5s
    environment:
      - DEBUG=False
      - SECRET_KEY=django-insecure-production-key-change-this
      - ALLOWED_HOSTS=django.niochat.com.br,localhost,127.0.0.1
      - DATABASE_URL=postgresql://postgres:Semfim01@@db.flojrapvlpueanbpvdab.supabase.co:5432/postgres
      - CORS_ALLOWED_ORIGINS=https://daytrack.niochat.com.br
    command: >
      sh -c "
      echo 'import json
from http.server import HTTPServer, BaseHTTPRequestHandler

class APIHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == \"/api/v1/\":
            self.send_response(200)
            self.send_header(\"Content-type\", \"application/json\")
            self.send_header(\"Access-Control-Allow-Origin\", \"*\")
            self.end_headers()
            response = {\"message\": \"DayTrack API funcionando!\", \"status\": \"ok\"}
            self.wfile.write(json.dumps(response).encode())
        else:
            self.send_response(404)
            self.end_headers()
            self.wfile.write(b\"Not Found\")

if __name__ == \"__main__\":
    server = HTTPServer((\"0.0.0.0\", 8000), APIHandler)
    server.serve_forever()' > /tmp/api.py &&
      python /tmp/api.py
      "

networks:
  nioNet:
    external: true
    name: nioNet
